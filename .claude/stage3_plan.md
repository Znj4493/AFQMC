# 阶段3实施计划：FGM对抗训练教学指导

## 📋 计划概览

**目标**: 通过对抗训练(FGM)提升模型性能,从70.19% F1-macro提升到74-76%

**教学方式**: 分步引导 + 互动提问 + 实践操作

**预计时间**: 3-4天

---

## 🎯 当前项目状态分析

### 已完成成果(阶段2)
- ✅ MacBERT baseline模型训练完成
- ✅ F1-macro: 70.19%, Accuracy: 74.12%
- ✅ 实现了AMP + 梯度累积优化
- ✅ 使用类别权重处理不平衡

### 存在问题
1. **Class 1性能较差**: F1=59.37% (vs Class 0: 81.02%)
2. **过拟合现象**: Epoch 3后验证loss上升
3. **性能差距**: 距离目标还差6-9个百分点

### 为什么选择对抗训练?
根据stage2_summary.md的分析,对抗训练可以:
- 提升模型鲁棒性(对输入微小变化不敏感)
- 减少过拟合(强迫模型学习更本质特征)
- **对少数类尤其有效**(Class 1样本少,更需要泛化能力)
- 预期提升: F1-macro +2~4%

---

## 📚 阶段3教学计划(分7步完成)

### 步骤1: 理论基础 - 什么是对抗训练? (用户自学)

**状态**: ✅ 用户通过视频自学

**学习内容**:
1. 对抗训练的动机(为什么需要?)
2. 对抗样本的概念
3. FGM算法的数学推导
4. 为什么对抗训练能提升泛化能力?

**学习资源**: 用户自选视频教程

---

### 步骤2: FGM算法详解 (用户自学)

**状态**: ✅ 用户通过视频自学

**学习内容**:
1. FGM的三个核心步骤:
   - 正常前向传播 + 反向传播
   - 在embedding层添加对抗扰动
   - 在对抗样本上再次前向传播 + 反向传播
2. 数学公式分解
3. 代码框架理解

**学习资源**: 用户自选视频教程

---

### 步骤3: 创建对抗训练模块 (实践 - 用户实现，我指导)

**目标**: 用户亲手创建adversarial.py文件,实现FGM类

**前置条件**:
- ✅ 已完成步骤1-2的理论学习
- ✅ 理解FGM的三个核心方法

**任务清单**:
1. [ ] 创建文件: `d:\XMU\AFQMC\src\adversarial.py`
2. [ ] 实现`FGM`类的结构
3. [ ] 实现`__init__()`方法
4. [ ] 实现`attack()`方法
5. [ ] 实现`restore()`方法
6. [ ] 添加详细的代码注释

**我的辅助方式**:
- 提供带空白的代码模板
- 在关键位置标注TODO，用户填写
- 提供测试代码验证正确性
- 解答实现过程中的疑问

**代码模板框架** (包含详细注释和TODO标记)

**完成标准**:
- [ ] 代码无语法错误
- [ ] 所有TODO部分已实现
- [ ] 理解每个方法的作用
- [ ] 能解释关键参数的意义

**验证方式**:
我会提供简单的测试代码，确保实现正确。

**预计时间**: 1-2小时

---

### 步骤4: 修改训练脚本 (我演示 + 用户实践)

**目标**: 将FGM集成到现有的train.py中

**修改内容**:
1. 导入FGM类
2. 在`train_epoch()`函数中添加对抗训练逻辑
3. 修改配置文件添加对抗训练开关

**关键知识点**:
- 对抗训练的正确位置(在哪里插入?)
- 梯度累积与对抗训练的配合
- AMP与对抗训练的兼容性

**预计时间**: 1-2小时

---

### 步骤5: 配置调整与测试 (互动)

**目标**: 调整超参数,准备开始训练

**配置内容**:
1. 添加对抗训练相关配置到config.py:
   - `USE_ADVERSARIAL = True`
   - `ADV_EPSILON = 1.0` (扰动强度)
2. 可能需要调整的其他参数:
   - 学习率(可能需要略微降低)
   - Early stopping patience

**预计时间**: 30分钟

---

### 步骤6: 训练与监控 (实践)

**目标**: 运行对抗训练,监控训练过程

**任务**:
1. 运行修改后的训练脚本
2. 观察训练日志的变化
3. 记录每个epoch的指标

**预期现象**:
- 训练时间增加约50%(每个batch要前向传播两次)
- 训练loss可能略高(因为样本更难)
- 验证loss应该更稳定(泛化能力提升)

**预计时间**: 3-4小时(训练) + 30分钟(分析)

---

### 步骤7: 结果分析与总结 (教学)

**目标**: 对比实验结果,理解对抗训练的效果

**分析内容**:
1. 性能对比: Baseline vs 对抗训练
2. 训练曲线分析: 过拟合是否缓解?
3. 混淆矩阵对比

**产出**:
- 对比实验报告
- 最佳模型保存
- 进阶优化方向(如果需要)

**预计时间**: 1-2小时

---

## 📁 需要创建/修改的文件

### 新建文件
1. `src/adversarial.py` - FGM对抗训练类(约100行)

### 修改文件
1. `src/train.py` - 集成对抗训练(修改train_epoch函数)
2. `config/config.py` - 添加对抗训练配置
3. `.claude/stage3_summary.md` - 训练后总结报告

---

## 🎓 核心知识点检查表

完成本阶段后,您应该掌握:
- [ ] 对抗训练的核心思想
- [ ] FGM算法的数学原理
- [ ] 如何在embedding层添加扰动
- [ ] 为什么对抗训练能提升泛化
- [ ] 如何调试对抗训练代码
- [ ] epsilon参数的物理意义
- [ ] 对抗训练与其他技术的配合

---

## ✅ 验证标准

### 最低要求
- F1-macro ≥ 72% (+2%)
- Class 1的F1 ≥ 65% (+6%)
- 验证loss不再上升(过拟合缓解)

### 理想目标
- F1-macro ≥ 74% (+4%)
- Class 1的F1 ≥ 68% (+9%)
- 达到阶段2目标的下限

### 如果超预期
- F1-macro ≥ 76%
- 可以直接进入阶段4(LLM微调)

---

## 📊 预期时间分配

| 步骤 | 内容 | 预计时间 | 类型 |
|-----|------|---------|------|
| 1 | 理论基础 | 自学 | 视频 |
| 2 | FGM算法详解 | 自学 | 视频 |
| 3 | 创建adversarial.py | 1-2h | 实践 |
| 4 | 修改训练脚本 | 1-2h | 实践 |
| 5 | 配置调整 | 0.5h | 配置 |
| 6 | 训练与监控 | 4h | 等待+分析 |
| 7 | 结果分析 | 1-2h | 总结 |

---

## 📍 关键文件路径

所有工作文件都在项目目录下：
- 项目根目录: `d:\XMU\AFQMC\`
- 新建文件: `d:\XMU\AFQMC\src\adversarial.py`
- 修改文件: `d:\XMU\AFQMC\src\train.py`
- 配置文件: `d:\XMU\AFQMC\config\config.py`
- 总结报告: `d:\XMU\AFQMC\.claude\stage3_summary.md`

---

**学完步骤1-2后，请回来开始步骤3！** 🎯
